name: Scrape Data

on:
  schedule:
    - cron: '0 */2 * * *'  # Every 2 hours
  workflow_dispatch:

permissions:
  contents: write

jobs:
  scrape:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repo
        uses: actions/checkout@v4
        
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          
      - name: Install scraper deps
        run: |
          cd scraper
          npm install axios cheerio
          
      - name: Run scraper
        id: scraper
        run: |
          echo "ðŸš€ Starting scraper..."
          cd scraper && node scraper.js
          echo "âœ… Scraper completed"
        timeout-minutes: 10
        # Removed continue-on-error - we want to know if it fails
        
      - name: Check file timestamps
        run: |
          echo "ðŸ“„ Checking data files..."
          ls -la data.json public/data.json 2>/dev/null || echo "Files not found"
          stat data.json public/data.json 2>/dev/null | grep Modify
        
      - name: Commit updated data
        id: commit
        run: |
          git config user.name "GitHub Actions"
          git config user.email "actions@github.com"
          
          # Check if data files exist and have changed
          if [ ! -f "data.json" ] && [ ! -f "public/data.json" ]; then
            echo "âŒ No data files found"
            exit 1
          fi
          
          # Show git status for debugging
          echo "ðŸ“Š Git status:"
          git status --short
          
          # Check for changes in data files
          if git diff --quiet HEAD -- data.json public/data.json 2>/dev/null; then
            echo "ðŸ“Š No changes detected in data files"
            echo "changed=false" >> $GITHUB_OUTPUT
          else
            echo "âœ… Changes detected - committing..."
            git add data.json public/data.json
            
            # Show what changed
            echo "ðŸ“ Changes summary:"
            git diff --stat HEAD -- data.json public/data.json || echo "Unable to show diff stats"
            
            git commit -m "ðŸ”„ Auto-scrape: $(date '+%Y-%m-%d %H:%M UTC')" || echo "Already up to date"
            git push
            echo "changed=true" >> $GITHUB_OUTPUT
            echo "âœ… Changes committed and pushed"
          fi
          
      - name: Verify deployment
        run: |
          echo "ðŸ“¦ Final data count:"
          cat public/data.json 2>/dev/null | grep -o '"allProducts"' | wc -l || echo "Could not read file"
